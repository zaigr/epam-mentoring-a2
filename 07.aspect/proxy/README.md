# AOP using Dynamic Proxy

In this project [client service](https://github.com/zaigr/epam-mentoring-a2/tree/master/05.msg-queues/client) of messaging task extended.

Method call logging advice added by using `Castle.Core` dynamic proxy generator. Aspect applied by using `Castle.Windsor` DI container.

## Advice

Logging advice implemented in `MethodCallLoggingAdvice.cs` class as proxy call interceptor.
```
    public class MethodCallLoggingAdvice : IInterceptor
    {
        public void Intercept(IInvocation invocation)
        {
            Log.Verbose($"[{DateTime.UtcNow}] - Call method '{invocation.Method.Name}' of type '{invocation.TargetType.FullName}'");

            if (invocation.Argument.Any())
            {
                LogArguments(invocation.Method.GetParameters(), invocation.Arguments);
            }

            invocation.Proceed();

            Log.Verbose($"[{DateTime.UtcNow}] - Method '{invocation.Method.Name}' returns '{invocation.ReturnValue}'");
        }

        private void LogArguments(IEnumerable<ParameterInfo> parameters, IEnumerable<object> values)
        {
            foreach (var paramValue in parameters
                .Zip(values, (p, v) => (parameter: p, value: v)))
            {
                Log.Verbose($"{paramValue.parameter.Name}" + " - {@value}", paramValue.value);
            }
        }
    }
```
Parameters logging implemented by [Serilog structured data](https://github.com/serilog/serilog/wiki/Structured-Data#preserving-object-structure) formatting.

## Aspect

Proxy class with aspect can be generated by using `MethodCallLoggingAspect.cs`
```
    public static class MethodCallLoggingAspect
    {
        public static T Apply<T>()
            where T : class
        {
            var generator = new ProxyGenerator();
            var proxy = generator.CreateClassProxy<T>(
                new MethodCallLoggingAdvice());

            return proxy;
        }
    }
```

In application code no need to call proxy generator directly. `Castle.Windsor` used to register all dependencies and apply aspect on them. See `ServiceLocator.cs` class for implementation.

```
...
kernel.Register(
    Component.For<IAvailabilityCheck>()
        .Interceptors<MethodCallLoggingAdvice>() // <- Advice registered
        .UsingFactoryMethod(
            _ => new AvailabilityCheck(
                    new ServiceBusQueueMessageSender(
...
```

## Logs

Logs are stream to file and console with help of `Serilog` sinks. Method call logged in the following order:
- name of type and method
- parameters name and value
- serialized return value

Values that cannot be serialized logged as type name

```
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Call method 'SyncExternalConfiguration' of type 'Client.ScanService.Configuration.External.ExternalConfigurationProvider'
[09:26:08 VRB] config - {"MessageMaxSizeBytes": 180, "LogFilePath": "ScanServiceLog.log", "MonitoringFoldersConfigFile": "ScanFolders.txt", "FolderScanFrequencySeconds": 30, "AvailabilityCheckFrequencySeconds": 10, "ClientId": "fe967f71-6164-453b-8eda-91cd5b1c6260", "DataQueueConnectionString": "Endpoint=sb://etl-sb-poc.servicebus.windows.net/;SharedAccessKeyName=RootPolicy;SharedAccessKey=LziGOa7UMlgc8yqvATrIgfWQd7RnxUJ9Hb6zViMA33Q=", "DataQueueName": "data-queue", "MonitoringQueueConnectionString": "Endpoint=sb://etl-sb-poc.servicebus.windows.net/;SharedAccessKeyName=RootPolicy;SharedAccessKey=npqMtk/k46o/py498ozKbJwU16aniZ0NRBfNfjhia1c=", "MonitoringQueueName": "monitoring-queue", "ConfigTopicConnectionString": "Endpoint=sb://etl-sb-poc.servicebus.windows.net/;SharedAccessKeyName=RootPolicy;SharedAccessKey=6U0k6rYLz6GqwxKFTFDmNPn4E8pgFSQIx1ljTTJ8oAI=", "ConfigTopicName": "configuration-topic", "ConfigTopicSubscriptionName": "client-service-configuration", "$type": "ServiceConfig"}
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Call method 'RegisterHandler' of type 'Client.MessageQueue.Receivers.ServiceBusSubscriptionMessageReceiver'
[09:26:08 VRB] handler - System.Func`2[Client.MessageQueue.Messages.ClientConfigurationMessage,System.Threading.Tasks.Task]
[09:26:08 VRB] exceptionHandler - System.Action`1[System.Exception]
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Method 'RegisterHandler' returns ''
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Method 'SyncExternalConfiguration' returns ''
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Call method 'StartMonitoring' of type 'Client.Core.Monitoring.FolderMonitor'
[09:26:08 VRB] resourcePaths - ["C:\\Users\\zahar\\Desktop\\Projects\\epam-mentoring-a2\\05.msg-queues\\client\\src\\app\\Client.WinService\\bin\\Debug\\a"]
[09:26:08 DBG] Start timer with interval '30' seconds.
[09:26:08 VRB] [12/6/2019 6:26:08 AM] - Method 'StartMonitoring' returns 'System.Threading.Tasks.Task'
[09:26:08 DBG] Start folders scanning.
```